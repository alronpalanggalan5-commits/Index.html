<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background: #111; color: #fff; text-align: center; font-family: sans-serif; }
        .ui { border: 2px solid #444; padding: 15px; background: #222; margin: 10px; border-radius: 10px; }
        canvas { border: 1px solid #555; max-width: 90%; display: none; }
        button { background: #007bff; color: #fff; border: none; padding: 15px; width: 90%; font-weight: bold; border-radius: 5px; margin-top: 10px; }
        img { margin-top: 20px; border: 2px solid #007bff; max-width: 90%; }
    </style>
</head>
<body>

<div class="ui">
    <h2>GIF_SHAKER_FIX</h2>
    <input type="file" id="picker" accept="image/*">
    <br><br>
    <canvas id="canvas"></canvas>
    <button id="genBtn" style="display:none;">GENERATE_SHAKY_GIF</button>
    <div id="result"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

<script>
const picker = document.getElementById('picker');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });
const genBtn = document.getElementById('genBtn');
const result = document.getElementById('result');
let img = new Image();

picker.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    img.src = URL.createObjectURL(file);
    img.onload = () => {
        // Keep it small for mobile speed
        canvas.width = 300; 
        canvas.height = 300;
        canvas.style.display = 'inline-block';
        genBtn.style.display = 'inline-block';
        draw(0, 0); 
    };
};

function draw(offsetX, offsetY) {
    ctx.clearRect(0, 0, 300, 300);
    // Draw the image with the shake offset
    ctx.drawImage(img, offsetX, offsetY, 300, 300);
    
    // Add a simple "glitch line" occasionally
    if(Math.random() > 0.7) {
        let y = Math.random() * 300;
        ctx.drawImage(canvas, 0, y, 300, 10, Math.random()*20-10, y, 300, 10);
    }
}

genBtn.onclick = () => {
    const gif = new GIF({
        workers: 0, // No worker to avoid security errors
        quality: 10,
        width: 300,
        height: 300
    });

    for (let i = 0; i < 10; i++) {
        // Create random heavy shake coordinates
        let sX = Math.floor(Math.random() * 30 - 15);
        let sY = Math.floor(Math.random() * 30 - 15);
        draw(sX, sY);
        gif.addFrame(canvas, {copy: true, delay: 50});
    }

    gif.on('finished', function(blob) {
        const url = URL.createObjectURL(blob);
        result.innerHTML = `<p>DONE! Long-press to save:</p><img src="${url}">`;
    });

    gif.render();
};
</script>
</body>
</html>
